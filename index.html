<!-- crypto_preview_debug_v2.html -->
<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX SecureMail Debug Preview</title>
  <style>
    body {font-family:'Segoe UI',Tahoma,sans-serif;background:#eef1f5;margin:0;padding:20px;color:#222;}
    .container {max-width:800px;margin:auto;background:#fff;padding:30px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
    h2{color:#0077cc;}
    textarea,input[type="file"],select,button{font-size:1em;margin-top:10px;width:100%;}
    textarea{height:120px;padding:10px;border-radius:5px;border:1px solid #ccc;resize:vertical;background:#f4f4f4;cursor:not-allowed;}
    .button-primary{background:#0077cc;color:#fff;padding:12px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;margin-top:15px;transition:background .3s;}
    .button-primary:hover{background:#005fa3;}
    .result{background:#f9f9f9;padding:20px;border-left:5px solid #0077cc;border-radius:6px;margin-top:25px;white-space:pre-wrap;}
    .hidden{display:none;}
    .error{color:#b00020;background:#ffe8e8;padding:12px;margin-top:10px;border-left:5px solid #b00020;border-radius:6px;}
    video{width:100%;border-radius:6px;margin-top:10px;}
    .attachment-list {margin-top:20px;}
    .attachment-item {padding:10px; border-bottom: 1px solid #ddd; display:flex; justify-content: space-between; align-items:center;}
    .attachment-name {font-weight:bold; flex-grow:1;}
    .attachment-buttons button {margin-left:8px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.js"></script>
 <script>
	// === ğŸ” Anti-Debug / DevTools Blocking ===
	(function () {
	  // ğŸ”’ Block F12, Ctrl+Shift+I/J/C, Ctrl+U
	  window.addEventListener('keydown', function (e) {
		const forbiddenKeys = (
		  e.key === 'F12' ||
		  (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
		  (e.ctrlKey && e.key.toLowerCase() === 'u')
		);
		if (forbiddenKeys) {
		  e.preventDefault();
		  alert('â›” Î‘Ï€Î±Î³Î¿ÏÎµÏÎµÏ„Î±Î¹ Î· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î± ÎµÏÎ³Î±Î»ÎµÎ¯Î± Î±Î½Î¬Ï€Ï„Ï…Î¾Î·Ï‚.');
		}
	  });

	  // ğŸ”’ Block Right Click
	  window.addEventListener('contextmenu', function (e) {
		e.preventDefault();
		alert('â›” Î”ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Ï„Î¿ Î´ÎµÎ¾Î¯ ÎºÎ»Î¹Îº.');
	  });

	  // ğŸ”’ Detect console inspection
	  setInterval(function () {
		const el = new Image();
		Object.defineProperty(el, 'id', {
		  get: function () {
			alert("â›” Debugger ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÏ„Î·ÎºÎµ!");
			document.body.innerHTML = "<h1 style='text-align:center;color:red;margin-top:20%'>â›” Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï„ÎµÏÎ¼Î±Ï„Î¯ÏƒÏ„Î·ÎºÎµ Î»ÏŒÎ³Ï‰ debugging.</h1>";
			throw new Error("Debugger Detected");
		  }
		});
		console.log(el);
	  }, 1000);

	  // ğŸ”’ Detect resize anomaly (DevTools open)
	  setInterval(() => {
		if (window.outerHeight - window.innerHeight > 120 || window.outerWidth - window.innerWidth > 160) {
		  document.body.innerHTML = "<h1 style='text-align:center;color:red;margin-top:20%'>â›” Î— Ï€ÏÎ¿Î²Î¿Î»Î® Î¼Ï€Î»Î¿ÎºÎ±ÏÎ¯ÏƒÏ„Î·ÎºÎµ (DevTools ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÏ„Î·ÎºÎµ).</h1>";
		}
	  }, 1000);
	})();
 </script>

</head>
<body>
  <div class="container">
    <h2>ğŸ” CryptoX Debug Preview</h2>
    <label><b>1. ÎšÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½Î¿ Î¼Î®Î½Ï…Î¼Î±:</b></label>
    <textarea id="blobInput" readonly></textarea>

    <p><b>2. QR ÎœÎ­Î¸Î¿Î´Î¿Ï‚:</b></p>
    <select id="qrMethod" onchange="toggleQRInputs()" class="button-primary">
      <option value="">-- Î•Ï€Î¹Î»Î¿Î³Î® --</option>
      <option value="file">ğŸ“ QR Î±Ï€ÏŒ ÎµÎ¹ÎºÏŒÎ½Î±</option>
      <option value="camera">ğŸ“· QR Î±Ï€ÏŒ ÎºÎ¬Î¼ÎµÏÎ±</option>
    </select>

    <div id="qrFileContainer" class="hidden">
      <input type="file" id="qrFile" accept="image/png, image/jpeg" />
    </div>

    <div id="qrCameraContainer" class="hidden">
      <button class="button-primary" onclick="startCamera()">ğŸ¥ ÎˆÎ½Î±ÏÎ¾Î· ÎºÎ¬Î¼ÎµÏÎ±Ï‚</button>
      <video id="qr-video" class="hidden" autoplay playsinline></video>
    </div>

    <label><b>3. Î£Ï…Î½Î·Î¼Î¼Î­Î½Î¿ (.xlzip):</b></label>
    <input type="file" id="attachmentFile" accept=".xlzip,.zip" />

    <button class="button-primary" id="decryptBtn">ğŸ”“ Î ÏÎ¿Î²Î¿Î»Î®</button>
    <div id="errorBox" class="error hidden"></div>

    <div class="result hidden" id="output">
      <h3>âœ‰ï¸ Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Email:</h3>
      <div id="emailContent"></div>
      <hr />
      <div id="attachmentList" class="attachment-list"></div>
    </div>
  </div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
const blobInput = document.getElementById("blobInput");
const decryptBtn = document.getElementById("decryptBtn");
const outputDiv = document.getElementById("output");
const emailContentDiv = document.getElementById("emailContent");
const errorBox = document.getElementById("errorBox");
const attachmentListDiv = document.getElementById("attachmentList");
const attachmentFileInput = document.getElementById("attachmentFile");

document.addEventListener("DOMContentLoaded", () => {
  const blob = getJoinedBlobParts();
  if (blob) blobInput.value = decodeURIComponent(blob);
  decryptBtn.addEventListener("click", decryptAll);
});

function toggleQRInputs() {
  ["qrFileContainer", "qrCameraContainer"].forEach(id => document.getElementById(id).classList.add("hidden"));
  const m = document.getElementById("qrMethod").value;
  if (m === "file") document.getElementById("qrFileContainer").classList.remove("hidden");
  else if (m === "camera") document.getElementById("qrCameraContainer").classList.remove("hidden");
}

async function decryptAll() {
  errorBox.classList.add("hidden");
  outputDiv.classList.add("hidden");
  emailContentDiv.innerHTML = "";
  attachmentListDiv.innerHTML = "";

  try {
    await decryptEmail();
    if (attachmentFileInput.files.length > 0)
      await decryptAttachmentFile(attachmentFileInput.files[0]);
  } catch (e) {
    showError("âŒ Î£Ï†Î¬Î»Î¼Î±: " + (e.message || e));
    console.error(e);
  }
}

async function decryptEmail() {
  const blob = blobInput.value.trim();
  if (!blob) throw showError("âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ blob.");
  const qrData = await getQRData();
  console.log("ğŸ“¦ Email QR:", qrData);
  const [keyHex] = qrData.split(":");
  const key = await crypto.subtle.importKey("raw", hexToBytes(keyHex), "AES-GCM", false, ["decrypt"]);

  const enc = base64ToBytes(blob);
  const nonce = enc.slice(0, 12), ct = enc.slice(12);
  console.log("ğŸ”‘ Decrypting email blob...");
  const dec = await crypto.subtle.decrypt({ name: "AES-GCM", iv: nonce }, key, ct);
  const decompressed = fflate.decompressSync(new Uint8Array(dec));
  const data = JSON.parse(new TextDecoder().decode(decompressed));
  console.log("âœ… Email Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®Î¸Î·ÎºÎµ:", data);

  if (!data.recipients?.includes(getParam("user")))
    throw showError("ğŸš« Î”ÎµÎ½ ÎµÎ¯ÏƒÏ„Îµ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¼Î­Î½Î¿Ï‚.");

  emailContentDiv.innerHTML = `<p><b>Î˜Î­Î¼Î±:</b> ${escapeHTML(data.subject)}</p><hr><p><b>Î£ÏÎ¼Î±:</b><br>${data.body.replace(/\n/g, "<br>")}</p>`;
  outputDiv.classList.remove("hidden");
}

async function decryptAttachmentFile(file) {
  console.log("ğŸ“ Î‘Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· ÏƒÏ…Î½Î·Î¼Î¼Î­Î½Î¿Ï…:", file.name);
  const qrData = await getQRData();
  console.log("ğŸ“¦ Attachment QR:", qrData);
  const [keyHex] = qrData.split(":");
  const key = await crypto.subtle.importKey("raw", hexToBytes(keyHex), "AES-GCM", false, ["decrypt"]);

  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const zipped = new Uint8Array(reader.result);
        const unzipped = fflate.unzipSync(zipped);
        const finalFiles = {};

        for (const name in unzipped) {
          const raw = new Uint8Array(unzipped[name]);
          console.log("ğŸ“„ Î•Î½Ï„Î¿Ï€Î¯ÏƒÏ„Î·ÎºÎµ Î±ÏÏ‡ÎµÎ¯Î¿:", name, "-", raw.byteLength, "bytes");

          try {
            const nonce = raw.slice(0, 12);
            const ct = raw.slice(12);
            const dec = await crypto.subtle.decrypt({ name: "AES-GCM", iv: nonce }, key, ct);
            finalFiles[name] = { data: new Uint8Array(dec), decrypted: true };
            console.log("âœ… Î‘ÏÏ‡ÎµÎ¯Î¿ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®Î¸Î·ÎºÎµ:", name);
          } catch (e) {
            console.warn(`âš ï¸ Î”ÎµÎ½ Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î®Î¸Î·ÎºÎµ: ${name}`, e);
            finalFiles[name] = { data: raw, decrypted: false };
          }
        }

        renderDecompressedFiles(finalFiles);
        resolve();
      } catch (e) {
        showError("âŒ Î ÏÏŒÎ²Î»Î·Î¼Î± Î±Ï€Î¿ÏƒÏ…Î¼Ï€Î¯ÎµÏƒÎ·Ï‚ Î® Î±Ï€Î¿ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·Ï‚: " + e.message);
        reject(e);
      }
    };
    reader.onerror = (e) => {
      showError("âŒ Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…: " + e.target.error);
      reject(e.target.error);
    };
    reader.readAsArrayBuffer(file);
  });
}

function renderDecompressedFiles(files) {
  attachmentListDiv.innerHTML = "<h4>ğŸ“ Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î± Î£Ï…Î½Î·Î¼Î¼Î­Î½Î¿Ï…:</h4>";
  for (const originalName in files) {
    const { data: fileData, decrypted } = files[originalName];
    let displayName = originalName;
    if (decrypted && displayName.endsWith(".encrypted_attachment")) {
      displayName = displayName.replace(/\.encrypted_attachment$/, "");
    }

    const itemDiv = document.createElement("div");
    itemDiv.className = "attachment-item";
    const nameSpan = document.createElement("span");
    nameSpan.className = "attachment-name";
    nameSpan.textContent = displayName + (decrypted ? " ğŸ”" : " ğŸŸ¡");

    const buttonsDiv = document.createElement("div");
    buttonsDiv.className = "attachment-buttons";

    const viewBtn = document.createElement("button");
    viewBtn.textContent = "Î ÏÎ¿Î²Î¿Î»Î®";
    viewBtn.className = "button-primary";
	viewBtn.onclick = () => {
	  const blob = new Blob([fileData]);
	  const url = URL.createObjectURL(blob);
	  const ext = displayName.split('.').pop().toLowerCase();
	  const previewable = ['pdf', 'png', 'jpg', 'jpeg', 'txt'];

	  if (previewable.includes(ext)) {
		window.open(url, "_blank");
	  } else {
		alert("Î”ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï€ÏÎ¿Î²Î¿Î»Î® Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… '" + displayName + "'. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï„Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÏ„Îµ.");
	  }
	};


    const saveBtn = document.createElement("button");
    saveBtn.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·";
    saveBtn.className = "button-primary";
    saveBtn.onclick = () => {
      const blob = new Blob([fileData]);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = displayName;
      a.click();
      URL.revokeObjectURL(url);
    };

    buttonsDiv.appendChild(viewBtn);
    buttonsDiv.appendChild(saveBtn);
    itemDiv.appendChild(nameSpan);
    itemDiv.appendChild(buttonsDiv);
    attachmentListDiv.appendChild(itemDiv);
  }
}

// === Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ­Ï‚ ===

function getParam(n) {
  return new URLSearchParams(window.location.search).get(n);
}
function getJoinedBlobParts(max = 50) {
  let blob = "";
  for (let i = 1; i <= max; i++) {
    const part = getParam("data" + i);
    if (part) blob += part;
    else break;
  }
  return blob || getParam("data") || "";
}
function escapeHTML(s) {
  return s.replace(/[&<>"']/g, ch => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[ch]));
}
function showError(msg) {
  errorBox.textContent = msg;
  errorBox.classList.remove("hidden");
}
function base64ToBytes(b64) {
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}
function hexToBytes(hex) {
  return new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
}
async function getQRData() {
  const method = document.getElementById("qrMethod").value;
  const qrFile = document.getElementById("qrFile").files[0];
  if (method === "camera" && window._qrDataFromCamera) return window._qrDataFromCamera;
  if (method === "file" && qrFile) return await readQRFromFile(qrFile);
  throw showError("âš ï¸ Î•Ï€Î¹Î»Î­Î¾Ï„Îµ QR ÎºÎ»ÎµÎ¹Î´Î¯.");
}
async function readQRFromFile(f) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement("canvas");
        c.width = img.width;
        c.height = img.height;
        const ctx = c.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const d = ctx.getImageData(0, 0, c.width, c.height);
        const code = jsQR(d.data, c.width, c.height);
        code ? res(code.data) : rej("QR not found");
      };
      img.src = reader.result;
    };
    reader.onerror = rej;
    reader.readAsDataURL(f);
  });
}
</script>
</body>
</html>